# Contributor: Sheila Aman <sheila@vulpine.house>
# Maintainer: Natanael Copa <ncopa@alpinelinux.org>
pkgname=python3
# the python3-tkinter's pkgver needs to be synchronized with this.
pkgver=3.12.12
_basever="${pkgver%.*}"
pkgrel=0
pkgdesc="High-level scripting language"
url="https://www.python.org/"
arch="all"
license="PSF-2.0"
# pyc0 comes last because the files are named without a unique substring
subpackages="
	$pkgname-dbg
	$pkgname-dev
	$pkgname-doc
	$pkgname-tests::noarch
	$pkgname-pyc:_default_pyc
	$pkgname-pycache-pyc2
	$pkgname-pycache-pyc1
	$pkgname-pycache-pyc0
	$pkgname-gdbm
	pyc:_pyc_meta:noarch
	"
depends="libssl3>=3.3.0"
makedepends="
	!gettext-dev
	bluez-headers
	bzip2-dev
	expat-dev
	gdbm-dev
	libffi-dev
	linux-headers
	mpdecimal-dev
	musl-libintl
	ncurses-dev
	openssl-dev
	readline-dev
	sqlite-dev
	tcl-dev
	xz-dev
	zlib-dev
	"
source="https://www.python.org/ftp/python/$pkgver/Python-$pkgver.tar.xz
	externally-managed
	musl-find_library.patch
	test_posix-nodev-disable.patch
	fix-run_fileexflags-test.patch
	https://github.com/python/cpython/commit/14b1fdb0a94b96f86fc7b86671ea9582b8676628.patch
  https://github.com/python/cpython/commit/9c9dda6625a2a90d2a06c657eee021d6be19842d.patch
  https://github.com/python/cpython/commit/4802b96a2cde58570c24c13ef3289490980961c5.patch
  https://github.com/python/cpython/commit/4ed11d3cd288e6b90196a15c5a825a45d318fe47.patch
  https://github.com/python/cpython/commit/62700107418eb2cca3fc88da036a243ea975f172.patch
  https://github.com/python/cpython/commit/a76e4cd62dd68e7cbe86e37e6ed988495a646b66.patch
  https://github.com/python/cpython/commit/5a8b19677d818fb41ee55f310233772e15aa1a2b.patch
  https://github.com/python/cpython/commit/c8a5f3435c342964e0a432cc9fb448b7dbecd1ba.patch
  ensurepip-version.patch
	https://raw.githubusercontent.com/python/cpython/3.13/Lib/ensurepip/_bundled/pip-26.0.1-py3-none-any.whl
	"

options="net" # Required for tests
builddir="$srcdir/Python-$pkgver"

# secfixes:
#   3.12.11-r0:
#     - CVE-2024-12718
#     - CVE-2025-4138
#     - CVE-2025-4330
#     - CVE-2025-4517
#   3.12.10-r1:
#     - CVE-2025-4516
#   3.12.9-r0:
#     - CVE-2025-0938
#   3.12.8-r1:
#     - CVE-2024-12254
#   3.12.8-r0:
#     - CVE-2024-9287
#   3.12.6-r0:
#     - CVE-2015-2104
#     - CVE-2023-27043
#     - CVE-2024-4032
#     - CVE-2024-6232
#     - CVE-2024-7592
#   3.12.5-r1:
#     - CVE-2024-8088
#   3.12.5-r0:
#     - CVE-2024-6923
#   3.11.5-r0:
#     - CVE-2023-40217
#   3.11.1-r0:
#     - CVE-2022-45061
#   3.10.5-r0:
#     - CVE-2015-20107
#   3.9.5-r0:
#     - CVE-2021-29921
#   3.9.4-r0:
#     - CVE-2021-3426
#   3.8.8-r0:
#     - CVE-2021-23336
#   3.8.7-r2:
#     - CVE-2021-3177
#   3.8.5-r0:
#     - CVE-2019-20907
#   3.8.4-r0:
#     - CVE-2020-14422
#   3.8.2-r0:
#     - CVE-2020-8315
#     - CVE-2020-8492
#   3.7.5-r0:
#     - CVE-2019-16056
#     - CVE-2019-16935
#   3.6.8-r1:
#     - CVE-2019-5010

# was briefly present, and is in 3.16
provides="pythonispython3=$pkgver-r$pkgrel"

prepare() {
	default_prepare

	# force system libs
	rm -r Modules/expat

	rm -f Lib/ensurepip/_bundled/*.whl

	cp "$srcdir/pip-26.0.1-py3-none-any.whl" Lib/ensurepip/_bundled/
}

build() {
	# set thread stack size to 2MB so we don't segfault before we hit
	# sys.getrecursionlimit()
	# note: raised from 1 as we ran into some stack limit on x86_64 too
	# sometimes, but not recursion
	local stacksize=0x200000

	# we want -O2 here for more speed for such a large interpreter.
	export CFLAGS_NODIST="$CFLAGS -O2 -DTHREAD_STACK_SIZE=$stacksize"
	export CXXFLAGS_NODIST="$CXXFLAGS -O2"
	export LDFLAGS_NODIST="$LDFLAGS -Wl,-z,stack-size=$stacksize"

	case "$CARCH" in
	ppc64le)
		# FIXME: on ppc64le, the stack-clash-protection from gcc seems to segfault
		# python.. sometimes. not sure if python or gcc bug (probably former)
		# for an easy reproduction, run the testsuite of community/py3-lmdb
		export CFLAGS_NODIST="${CFLAGS_NODIST/-fstack-clash-protection}"
		export CXXFLAGS_NODIST="${CXXFLAGS_NODIST/-fstack-clash-protection}"
		;;
	esac


	# we set them via NODIST to not propagate them and duplicate them to modules
	unset LDFLAGS CFLAGS CXXFLAGS CPPFLAGS

	./configure \
		--build=$CBUILD \
		--host=$CHOST \
		--prefix=/usr \
		--enable-ipv6 \
		--enable-loadable-sqlite-extensions \
		--enable-optimizations \
		--enable-shared \
		--with-lto \
		--with-computed-gotos \
		--with-dbmliborder=gdbm:ndbm \
		--with-system-expat \
		--with-system-libmpdec \
		--with-ensurepip=install

	NPROC=$(nproc || echo 2)
	make -j${NPROC}
}

check() {
	# test that we reach recursionlimit before we segfault
	cat > test-stacksize.py <<-EOF
	import threading
	import sys

	def fun(i):
	  try:
	    fun(i+1)
	  except:
	    sys.exit(0)

	t = threading.Thread(target=fun, args=[1])
	t.start()
EOF
	LD_LIBRARY_PATH=$PWD ./python test-stacksize.py

	local fail
	local ignore

	# musl related
	fail="test__locale"					# various musl locale deficiencies
	fail="$fail test_locale"
	fail="$fail test_re"
	fail="$fail test_c_locale_coercion"
	fail="$fail test_datetime"				# hangs if 'tzdata' installed
	fail="$fail test_os"					# fpathconf, ttyname errno values
	ignore="test.test_strptime.StrptimeTests.test_date_locale2"

	# FIXME: failures needing investigation
	fail="$fail test_ctypes"				# fail on aarch64 (ctypes.test.test_win32.Structures)

	# kernel related
	fail="$fail test_fcntl"					# wants DNOTIFY, we don't have it

	# test_clock_settime returns Function not implemented instead of the
	# expected permission error in docker (CI). Disable for now.
	case "$CARCH" in
		ppc64le) fail="$fail test_time";;
	esac

	make quicktest TESTOPTS="-j${JOBS:-$(nproc)} --exclude $fail --ignore $ignore"
}

package() {
	make -j1 DESTDIR="$pkgdir" EXTRA_CFLAGS="$CFLAGS" install maninstall
	install -Dm644 LICENSE "$pkgdir"/usr/share/licenses/$pkgname/LICENSE

	install -Dm644 "$srcdir"/externally-managed \
		"$pkgdir"/usr/lib/python$_basever/EXTERNALLY-MANAGED

	# those are provided by python3-tkinter
	rm -r "$pkgdir"/usr/bin/idle* "$pkgdir"/usr/lib/python*/idlelib \
		"$pkgdir"/usr/lib/python*/tkinter

	ln -s pip3 "$pkgdir"/usr/bin/pip
	ln -s python3 "$pkgdir"/usr/bin/python
	ln -s python3-config "$pkgdir"/usr/bin/python-config
}

dev() {
	default_dev

	# pyconfig.h is needed runtime so we move it back
	mkdir -p "$pkgdir"/usr/include/python$_basever
	mv "$subpkgdir"/usr/include/python$_basever/pyconfig.h \
		"$pkgdir"/usr/include/python$_basever/
}

tests() {
	pkgdesc="The test modules from the main python package"

	amove usr/lib/python$_basever/test
}

gdbm() {
	pkgdesc="Python backend for GNU gdbm"

	amove usr/lib/python3*/lib-dynload/_gdbm.cpython*
}

_pyc_meta() {
	pkgdesc="Meta package for pulling in all -pyc packages"
	depends=""
	mkdir -p "$subpkgdir"
}

# python3-pyc, to install pyc by default
_default_pyc() {
	pkgdesc="$pkgdesc (install .pyc cache files)"
	install_if="$pkgname=$pkgver-r$pkgrel"
	depends="
		$pkgname-pycache-pyc0=$pkgver-r$pkgrel
		pyc
		"

	mkdir -p "$subpkgdir"
}

pyc0() {
	pkgdesc="$pkgdesc (.pyc pycache files)"

	cd "$pkgdir"
	amove $(find usr/lib/python3* -name "*.pyc")
}

pyc1() {
	pkgdesc="$pkgdesc (.opt-1.pyc pycache files)"

	cd "$pkgdir"
	amove $(find usr/lib/python3* -name "*.opt-1.pyc")
}

pyc2() {
	pkgdesc="$pkgdesc (.opt-2.pyc pycache files)"

	cd "$pkgdir"
	amove $(find usr/lib/python3* -name "*.opt-2.pyc")
}

sha512sums="
4b99d240dd96a6e154909dcffe87f8bb38193d634cd80a1c3d9e819b7a63af2afa46d5e6423e81f00dd388840dc29a4a71580f6aa1ce9a12e559c1d63f65a205  Python-3.12.12.tar.xz
46dd8230ee2ab66e9c4157c10b2bd9c414fd7f30be0bee73e21a9eea88f63fff362d47828e0fc77ddc59df097b414b21505f8b5f98bc866381115c58ae3f4862  externally-managed
ab8eaa2858d5109049b1f9f553198d40e0ef8d78211ad6455f7b491af525bffb16738fed60fc84e960c4889568d25753b9e4a1494834fea48291b33f07000ec2  musl-find_library.patch
606cf7b3df0c81c90571c6bc65e4f07e065867739fa0d36e9c8e1ad2d6bcd64d265f90c4a7881880fc7e0c85eed94d1f72655a5c70d92ca63e5cc4bd3be8f145  test_posix-nodev-disable.patch
0e1155b1976be46d68fe50161b9644ac272d95c51f44ada51a0fd67a0154df89833752e97cfc85e977b384fca82b58907c30405a103f3a33a1483b9f76ce632f  fix-run_fileexflags-test.patch
8cda8bd89d8c87ac7e9f5f59e1fcde5e29b634f19a63402f33d8189a8a0d6bec534692e6ed19cc1d793a50a49e1db4498f83490c20f1c53f76cb45f02d74d860  df996ce4b9860f8d0c391d876ffe6d0143132a81.diff
b61cd1b95b0e3f045087832a56bc38dece2d33bedb1cfdc591a2a784c2def74ab99614ff902c4efd7ea39c924536385eb1b36f7ead88c162102df629d99cc7c0  1ff4985dccfe14ccb59eaac7f2611764a635f828.diff
93ae4f90565b03b3c2ff25ab70ae892653320057cf52328aed52269d739fba77983414de7fe1980e79d222df93f2a01814feb89b42cfe0c03542b07aba7e37f1  d9c479e5ed98b2f019b4fb9658f0093b800b9f2e.diff
f2ceb029ed16296fa53a525c5efadd6a3e61cdd2ffd38f09d6a786a3909abfaf0f64af763f3f8ec9878d6eb271208ba56531f57b4b7be694cd0b51bd0ff825d4  c2d62026344bd3d8282385c2545991f8bfc8b9bd.diff
cd82f30db875d4a61dac20e9e3244dbed5584d963014b3ff5a7f9754ada0a9b1bbfb1663fcc49e47ce29989bffe10d9c0248a3887b2e29f2fb7d639a6570b2d5  03336d7373be3eb6dcdd94a075089c417dda5df1.diff
f3f09fe78bb6c05aba8d30773a36f014b892167025ef4bfbd838135b2d0ea28479b0573166b81de8320b2e36106ded9971fbd8a931810211e6b10ef0f0c19fd3  c02c7df621d2dfbd0d8b0009037283ebe18a28d7.diff
"
