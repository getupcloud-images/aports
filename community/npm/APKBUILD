# Contributor: Jakub Jirutka <jakub@jirutka.cz>
# Maintainer: Jakub Jirutka <jakub@jirutka.cz>
pkgname=npm
pkgver=10.9.4
pkgrel=0
pkgdesc="The package manager for JavaScript"
url="https://www.npmjs.com/"
arch="noarch"
license="Artistic-2.0"
depends="nodejs"
replaces="nodejs-doc"  # for backward compatibility
subpackages="$pkgname-doc $pkgname-bash-completion"
# https://registry.npmjs.org/npm/-/npm-$pkgver.tgz
source="cli-${pkgver}.tar.gz::https://github.com/npm/cli/archive/refs/tags/v${pkgver}.tar.gz
	npmrc
	"
	#dont-check-for-last-version.patch ## this fails tests
builddir="$srcdir/cli-${pkgver}"

# secfixes:
#   10.9.1-r0:
#     - CVE-2024-21538
#   8.1.4-r0:
#     - CVE-2021-43616

prepare() {
	default_prepare

  git init .
  git remote add origin "git+https://github.com/npm/cli.git" # satisfies test #79 test/lib/commands/publish.js
  git add .
  git config --global user.name || git config --global user.name "Quor"
  git config --global user.email || git config --global user.email "quor@quor.dev"
  git commit -am 'Placeholder'

  node scripts/resetdeps.js

  ## From https://github.com/npm/cli/wiki/Release-Process#updating-dependencies
  node . i @npmcli/template-oss@latest --workspaces --include-workspace-root --save-exact
  node . i @npmcli/metavuln-calculator@9.0.0
  node . i glob@10.5.0
  node . i tar@7.5.7
  node . i diff@5.2.2
  node . i pacote@21.0.1
  node . i tar@7.5.7 --workspaces ## This is not working as expected.

  npmtarball="$(node . pack --loglevel=silent --json | jq -r .[0].filename)"
  rm -rf $builddir/package
  tar xzf $npmtarball -C $builddir
  cd $builddir/package

	# Remove bunch of unnecessary files to reduce size of the package.

	# Wrapper scripts written in Bash and CMD.
	rm bin/npm bin/npx bin/*.cmd
	rm README.md
	# HTML docs
	rm -rf docs

	cd node_modules

	find . -type f \( \
		-name '.*' -o \
		-name '*.cmd' -o \
		-name '*.bat' -o \
		-name '*.map' -o \
		-name '*.md' -o \
		\( -name '*.ts' -a ! -name '*.d.ts' \) -o \
		-name 'AUTHORS*' -o \
		-name 'LICENSE*' -o \
		-name 'license' -o \
		-name 'Makefile' -o \
		-name 'README*' -o \
		-name 'readme.markdown' \) -delete
	rm -rf ./*/.git* ./*/doc ./*/docs ./*/examples ./*/scripts ./*/test
	rm -rf ./node-gyp/gyp/.git*

	# No files should be executable here, except node-gyp.
	find . -type f -executable ! -name 'node-gyp*' -exec chmod -x {} \;

	cd ../man

	# XXX: Workaround for https://github.com/npm/cli/issues/780.
	local f name sec title
	for f in man5/folders.5 man5/install.5 man7/*.7; do
		sec=${f##*.}
		name=$(basename $f .$sec)
		title=$(echo "$name" | tr '[:lower:]' '[:upper:]')

		sed -Ei "s/^\.TH \"$title\"/.TH \"NPM-$title\"/" "$f"
		mv "$f" "${f%/*}/npm-$name.$sec"
	done
}

check() {
  cd "$builddir/package"
	./bin/npm-cli.js --version
	./bin/npx-cli.js --version
  cd "$builddir"
  # run tests for debugging purpose only
  node . run test || true
}

package() {
	local destdir="$pkgdir/usr/lib/node_modules/npm"

	mkdir -p "$destdir"
	cp -r "$builddir"/package/* "$destdir"/
	cp "$srcdir"/npmrc "$destdir"/

	cd "$pkgdir"

	mkdir -p usr/bin
	ln -s ../lib/node_modules/npm/bin/npm-cli.js usr/bin/npm
	ln -s ../lib/node_modules/npm/bin/npx-cli.js usr/bin/npx
	ln -s ../lib/node_modules/npm/node_modules/node-gyp/bin/node-gyp.js usr/bin/node-gyp

	mkdir -p usr/share
	mv "$destdir"/man usr/share/
	ln -s ../../../share/man "$destdir"/man

	mkdir -p usr/share/licenses/$pkgname
	mv "$destdir"/LICENSE usr/share/licenses/$pkgname/

	install -D -m644 "$destdir"/lib/utils/completion.sh \
		"$pkgdir"/usr/share/bash-completion/completions/npm
}

doc() {
	default_doc

	amove usr/lib/node_modules/npm/man
}

sha512sums="
e2945ec43553d19d291e74e1124b3bd854cce512fcedf2d4cb470c874d3ec42baf14493b42b0ea31d33526df2608605ed737dd164b348ea01a9afab2b4317a9c  npm-10.9.0.tar.gz
17decd8b410c6596b18be5211db6d33c9fa5124126fe27530e44649e2aa9339b6f6fbd7f7603d9965a5878fd02e4c704c27c9e19f56a48d4777f381df86c6d46  update-tar.patch
bf1362f6ad18738f54f30976e13da066293e21d0d3d81a5c2802f1064e49fa9bc7693b7e73e58f6c8f7fa545edcbb2dbac4b9c69165a9efc69f32fbc1e676597  dont-check-for-last-version.patch
6d0ce425061ffff1c5d7a42c9908f3382cd77abf81a9c30a62ff6fff1f0d02ff633b2bb090814aa619f7d2a51237b3da7f85d97d0f584e037639b60ccfaf0e96  npmrc
"
